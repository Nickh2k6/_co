### 1. Sys.jack (系統核心服務)

這個類別負責作業系統的生命週期管理，包括啟動、暫停和錯誤處理。

* **初始化 (`init`)**：
* 這是 OS 啟動後執行的第一個函式。它負責按順序初始化所有其他 OS 模組，例如 `Math`、`Output`、`Screen`、`Keyboard` 和 `Memory`。
* 初始化完成後，它會呼叫使用者程式的進入點 `Main.main()`，程式結束後則呼叫 `Sys.halt()` 停止系統。


* **停止執行 (`halt`)**：
* 透過一個無窮迴圈 `while(true){}` 來讓 CPU 進入空轉狀態，達到「停止」程式的效果。


* **等待 (`wait`)**：
* 提供延遲功能。由於 Hack 平台沒有硬體時鐘中斷，它透過執行空迴圈（巢狀迴圈）來消耗 CPU 週期，從而達到約略的延遲效果（單位為毫秒）。


* **錯誤處理 (`error`)**：
* 當系統發生錯誤時（如陣列越界、除以零），會印出 "ERR<錯誤代碼>" 並停止系統。



### 2. Math.jack (數學函式庫)

由於 Hack 硬體（ALU）只支援加法和減法，乘法、除法等高階運算必須由軟體（OS）來實作。為了效率，這裡大量使用了位元運算。

* **初始化 (`init`)**：
* 預先計算並儲存 2 的 0 到 15 次方（`powers_of_two` 陣列），這是一個查表法優化，用於快速進行位元測試和位移運算。


* **位元操作 (`bit`, `two_to_the`)**：
* 輔助函式，用於檢查某個整數的第 n 個位元是否為 1，或取得 2^n 的值。


* **乘法 (`multiply`)**：
* 實作了「位移相加」(Shift-and-Add) 演算法。透過檢查乘數 y 的每個位元，若該位元為 1，則將對應位移後的 x 加到總和中。這比連加法（x 加 y 次）效率高得多，時間複雜度為 O(n)（這裡是 O(16)）。


* **除法 (`divide`)**：
* 實作了長除法 (Long Division) 的遞迴版本。它先將除數倍增直到大於被除數，然後回溯計算商數。這同樣比連減法效率高。


* **開根號 (`sqrt`)**：
* 使用類似二分搜尋法的逐位元測試法。從最高位元開始嘗試，如果 `(y + 2^j)^2` 不超過 x，則該位元為 1。



### 3. Memory.jack (記憶體管理)

負責管理 Heap（堆積）記憶體，提供動態記憶體分配 (`alloc`) 和釋放 (`deAlloc`) 功能。Hack 電腦的 Heap 區域通常是 RAM 2048 到 16383。

* **記憶體結構**：
* 使用 **Free List (空閒鏈結串列)** 來追蹤可用的記憶體區塊。每個區塊包含兩個 Header：`length` (長度) 和 `next` (指向下一個空閒區塊的指標)。


* **直接存取 (`peek`, `poke`)**：
* 利用 Hack 語言中 Array 的特性，將 `memory` 定義為基底位址為 0 的陣列，藉此直接讀寫任意 RAM 位址的值。


* **配置 (`alloc`)**：
* 實作了 **Best Fit (最佳適應)** 演算法。它會遍歷 Free List，尋找大於需求且大小最接近的區塊，以減少記憶體碎片。
* 找到區塊後，若區塊太大，會將其分割 (`do_alloc`)，一部分返回給使用者，剩餘部分留在 Free List 中。


* **釋放 (`deAlloc`)**：
* 將使用完的記憶體區塊放回 Free List 中。這個實作包含了一個進階功能：**Coalescing (合併)**。它會檢查被釋放區塊的前後是否有相鄰的空閒區塊，如果有，就將它們合併成一個大區塊，這能有效防止記憶體碎片化。



### 4. Array.jack (陣列抽象層)

這是對 `Memory` 類別的高階封裝，讓使用者能以物件導向的方式使用陣列。

* **建構 (`new`)**：
* 呼叫 `Memory.alloc(size)` 來在 Heap 中請求一塊連續空間。


* **釋放 (`dispose`)**：
* 呼叫 `Memory.deAlloc(this)` 來釋放該陣列佔用的空間。注意，`this` 指標本身就是指向該記憶體區塊的位址。



### 總結

這組程式碼展現了如何在低階硬體上建構高階語言所需的基礎設施：

1. **Sys** 負責流程控制。
2. **Math** 用軟體補足硬體運算能力的缺失。
3. **Memory** 實作了複雜的堆積管理（鏈結串列與合併演算法）。
4. **Array** 提供了方便的資料結構介面。